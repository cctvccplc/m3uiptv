<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal IPTV - Side-by-Side View</title>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/dashjs@latest/dist/dash.all.min.js"></script>

    <style>
        :root {
            --overlay-bg: rgba(0,0,0,0.95);
            --accent: #3b82f6;
            --text: #fff;
            --glass: rgba(255,255,255,0.1);
            --sidebar-width: 320px;
            --cat-width: 260px;
        }
        body, html { margin:0; padding:0; background:#000; color:var(--text); font-family:sans-serif; height:100vh; width:100vw; overflow:hidden;}

        /* প্লেয়ার কন্টেইনার - এটি ডাইনামিক ভাবে ছোট বড় হবে */
        #player-container { 
            position: fixed; 
            top: 0; 
            right: 0; 
            bottom: 0; 
            left: 0; /* শুরুতে ফুল স্ক্রিন */
            z-index: 1; 
            background: #000;
            transition: left 0.3s ease-in-out; 
        }

        /* যখন সাইডবার ওপেন হবে তখন ভিডিও ডানে সরে যাবে */
        body.sidebar-open #player-container { left: var(--sidebar-width); }
        body.cat-open #player-container { left: var(--cat-width); }

        video { width: 100%; height: 100%; object-fit: contain; outline: none; }

        /* সাইডবার প্যানেল */
        .overlay-panel { 
            position: fixed; 
            top: 0; 
            bottom: 0; 
            z-index: 50; 
            background: var(--overlay-bg); 
            transition: transform 0.3s ease-in-out;
        }
        
        #category-nav { width: var(--cat-width); transform: translateX(-100%); border-right: 1px solid var(--glass); left: 0;}
        #channel-nav { width: var(--sidebar-width); transform: translateX(-100%); border-right: 1px solid var(--glass); left: 0;}

        /* শো/হাইড ক্লাস */
        #category-nav.show { transform: translateX(0); }
        #channel-nav.show { transform: translateX(0); }

        .nav-header { padding: 20px; font-weight: bold; border-bottom: 1px solid var(--glass); color: var(--accent); font-size: 1.2rem;}
        .list-container { height: calc(100% - 70px); overflow-y: auto; padding: 10px; }
        .item { 
            padding: 12px 15px; margin: 5px 0; border-radius: 8px; 
            display: flex; align-items: center; cursor: pointer; 
            background: rgba(255,255,255,0.05); transition: 0.2s; outline: none;
        }
        .item:focus, .item:hover { background: var(--accent); color: #fff; transform: scale(1.02); }
        .item.active { border-left: 4px solid var(--accent); background: rgba(59,130,246,0.2); }
        .item img { width: 45px; height: 30px; margin-right: 12px; object-fit: contain; background: #222; border-radius: 4px; }

        #info-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px 25px; border-radius: 30px; display: none; z-index: 100; border: 1px solid var(--accent); }
        .setup-screen { position: fixed; inset: 0; z-index: 200; background: #000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .setup-box { width: 100%; max-width: 350px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 8px 0; background: #111; border: 1px solid var(--accent); color: #fff; border-radius: 8px; }
        button { width: 100%; padding: 14px; background: var(--accent); border: 0; color: #fff; font-weight: bold; border-radius: 8px; cursor: pointer; }
    </style>
</head>

<body>

<div id="boot_loader" class="setup-screen">
    <div class="setup-box">
        <h2>UNIVERSAL IPTV</h2>
        <input id="m3u_input" placeholder="M3U URL">
        <p style="margin:5px; opacity:0.5">-- OR --</p>
        <input id="xtream_url" placeholder="Server URL (http://...)">
        <input id="xtream_user" placeholder="Username">
        <input id="xtream_pass" type="password" placeholder="Password">
        <button onclick="processLogin()">START PLAYER</button>
    </div>
</div>

<div id="player-container">
    <video id="player" playsinline controls autoplay></video>
</div>

<div id="category-nav" class="overlay-panel">
    <div class="nav-header">CATEGORIES</div>
    <div class="list-container" id="category_list"></div>
</div>

<div id="channel-nav" class="overlay-panel">
    <div class="nav-header" id="group_name">CHANNELS</div>
    <div class="list-container" id="channel_list"></div>
</div>

<div id="info-bar">
    <span id="info_name" style="font-weight:bold"></span> | <span id="info_group"></span>
</div>

<script>
let allChannels = [];
let hls = null, dash = null;
const video = document.getElementById("player");
const chanNav = document.getElementById("channel-nav");
const catNav = document.getElementById("category-nav");
const body = document.body;

async function processLogin() {
    let url = document.getElementById("m3u_input").value;
    const x = document.getElementById("xtream_url").value;
    const u = document.getElementById("xtream_user").value;
    const p = document.getElementById("xtream_pass").value;
    if(x && u && p) url = `${x}/get.php?username=${u}&password=${p}&output=m3u8`;
    if(!url) return alert("Source URL Missing");

    try {
        const r = await fetch(url);
        parseM3U(await r.text());
        document.getElementById("boot_loader").style.display = "none";
        // ওপেনিংয়েই সাইডবার দেখানোর জন্য
        showChannels();
    } catch(e) { alert("Playlist Load Error"); }
}

function parseM3U(data) {
    allChannels = []; const groups = new Set(); let current = null;
    data.split("\n").forEach(l => {
        l = l.trim();
        if(l.startsWith("#EXTINF")) {
            current = {
                name: l.split(",").pop().trim(),
                logo: l.match(/tvg-logo="([^"]+)"/)?.[1] || "",
                group: l.match(/group-title="([^"]+)"/)?.[1] || "General"
            }; 
            groups.add(current.group);
        } else if(l.startsWith("http") && current) {
            current.url = l; allChannels.push(current); current = null;
        }
    });
    renderCategories(Array.from(groups).sort());
    renderChannels(allChannels);
}

function renderCategories(groups) {
    const container = document.getElementById("category_list");
    container.innerHTML = `<div class="item" tabindex="0" onclick="filterGroup('all')">ALL CHANNELS</div>`;
    groups.forEach(g => {
        const d = document.createElement("div"); d.className = "item"; d.tabIndex = 0;
        d.innerText = g; d.onclick = () => filterGroup(g);
        container.appendChild(d);
    });
}

function renderChannels(list) {
    const container = document.getElementById("channel_list");
    container.innerHTML = "";
    list.forEach(ch => {
        const d = document.createElement("div"); d.className = "item"; d.tabIndex = 0;
        d.innerHTML = `<img src="${ch.logo}" onerror="this.style.display='none'"><span>${ch.name}</span>`;
        d.onclick = () => playChannel(ch, d);
        container.appendChild(d);
    });
}

function filterGroup(g) {
    document.getElementById("group_name").innerText = g.toUpperCase();
    const filtered = g === 'all' ? allChannels : allChannels.filter(c => c.group === g);
    renderChannels(filtered);
    showChannels();
}

function showChannels() {
    chanNav.classList.add("show");
    catNav.classList.remove("show");
    body.classList.add("sidebar-open");
    body.classList.remove("cat-open");
    setTimeout(() => document.querySelector("#channel_list .item")?.focus(), 100);
}

function showCategories() {
    catNav.classList.add("show");
    chanNav.classList.remove("show");
    body.classList.add("cat-open");
    body.classList.remove("sidebar-open");
    setTimeout(() => document.querySelector("#category_list .item")?.focus(), 100);
}

function hideBars() {
    chanNav.classList.remove("show");
    catNav.classList.remove("show");
    body.classList.remove("sidebar-open", "cat-open");
    video.focus();
}

function playChannel(ch, el) {
    document.querySelectorAll(".item").forEach(x => x.classList.remove("active"));
    if(el) el.classList.add("active");

    if(hls) { hls.destroy(); hls=null; }
    if(dash) { dash.reset(); dash=null; }

    if(ch.url.endsWith(".mpd")) { 
        dash=dashjs.MediaPlayer().create(); 
        dash.initialize(video,ch.url,true);
    } else if(Hls.isSupported()) { 
        hls=new Hls(); hls.loadSource(ch.url); hls.attachMedia(video);
    } else video.src = ch.url;

    document.getElementById("info_name").innerText = ch.name;
    document.getElementById("info_group").innerText = ch.group;
    const bar = document.getElementById("info-bar");
    bar.style.display="block"; setTimeout(()=>bar.style.display="none",4000);

    hideBars(); // ভিডিও শুরু হলে সাইডবার অটো সরে যাবে
}

/* রিমোট এবং টাচ কন্ট্রোল */
document.addEventListener("keydown", e => {
    const active = document.activeElement;

    if(e.key === "Backspace" || e.key === "Escape") {
        e.preventDefault();
        hideBars();
        return;
    }

    // সাইডবার বন্ধ থাকলে বাম চাপলে ওপেন হবে
    if(!body.classList.contains("sidebar-open") && !body.classList.contains("cat-open")) {
        if(["ArrowLeft", "ArrowUp", "ArrowDown", "Enter"].includes(e.key)) {
            showChannels();
            return;
        }
    }

    if(e.key === "ArrowDown") { e.preventDefault(); active?.nextElementSibling?.focus(); }
    if(e.key === "ArrowUp") { e.preventDefault(); active?.previousElementSibling?.focus(); }

    if(e.key === "ArrowLeft") { 
        if(body.classList.contains("sidebar-open")) showCategories(); 
    }
    if(e.key === "ArrowRight") { 
        if(body.classList.contains("cat-open")) showChannels();
        else if(body.classList.contains("sidebar-open")) hideBars();
    }
    
    if(e.key === "Enter" || e.keyCode === 13) active?.click();
});

// ভিডিও স্ক্রিনে টাচ করলে মেনু আসবে (মোবাইল/টাচ টিভি)
video.addEventListener("click", () => {
    if(!body.classList.contains("sidebar-open")) showChannels();
    else hideBars();
});

</script>
</body>
</html>
