<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'/>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' name='viewport'/>
    <title>IPTV PRO - Navigation Fixed</title>
    
    <script src='https://cdn.jsdelivr.net/npm/hls.js@latest'></script>
    <script src='https://cdn.jsdelivr.net/npm/dashjs@latest/dist/dash.all.min.js'></script>

    <style>
    :root { --panel-bg: rgba(12, 12, 12, 0.98); --accent: #3b82f6; --glass: rgba(255, 255, 255, 0.08); --bg: #0a0a0a; }
    body, html { margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; touch-action: pan-y; }
    
    #loader { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

    .setup-screen { position: fixed; inset: 0; z-index: 999; background: #000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .setup-box { background: #111; padding: 35px; border-radius: 25px; border: 1px solid #333; width: 100%; max-width: 420px; text-align: center; }
    .setup-input { width: 100%; padding: 14px; background: #1a1a1a; border: 1px solid #444; color: #fff; border-radius: 12px; outline: none; box-sizing: border-box; margin-bottom: 15px;}
    
    .btn-primary { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
    .btn-secondary { width: 100%; padding: 12px; background: #222; color: #fff; border: 1px solid #444; border-radius: 12px; cursor: pointer; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }

    #player-container { position: fixed; inset: 0; z-index: 1; background: #000; }
    video { width: 100%; height: 100%; object-fit: contain; }

    .overlay-panel { position: fixed; top: 0; bottom: 0; z-index: 100; background: var(--panel-bg); width: 280px; transform: translateX(-100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-right: 1px solid #333; backdrop-filter: blur(20px); }
    .overlay-panel.show { transform: translateX(0); }
    
    .search-box { padding: 15px; border-bottom: 1px solid #333; }
    .search-box input { width: 100%; padding: 10px; background: #222; border: 1px solid #444; border-radius: 8px; color: #fff; outline: none; }

    .nav-header { padding: 20px; font-weight: bold; border-bottom: 1px solid #333; color: var(--accent); display: flex; justify-content: space-between; align-items: center; }
    .list-container { height: calc(100% - 180px); overflow-y: auto; padding: 15px; }
    
    .item { padding: 12px; margin-bottom: 8px; border-radius: 10px; display: flex; align-items: center; cursor: pointer; background: var(--glass); outline: none; border: 2px solid transparent; }
    .item:focus { border-color: var(--accent); background: rgba(59, 130, 246, 0.2); }
    .item img { width: 35px; height: 35px; margin-right: 12px; border-radius: 5px; }

    .pip-btn { position: fixed; bottom: 20px; right: 20px; z-index: 101; background: var(--accent); border: none; color: #fff; padding: 10px; border-radius: 50%; cursor: pointer; display: none; }
    </style>
</head>
<body onclick='handleGlobalClick(event)'>

    <div id="loader"></div>

    <div class='setup-screen' id='boot_loader'>
        <div class='setup-box'>
            <h2 style="color:var(--accent)">IPTV Manager Pro</h2>
            <input class='setup-input' id='pl_url' placeholder='Paste M3U Link here...' type='text'/>
            <button class='btn-primary' onclick='loadFromLink(true)'>Load Playlist</button>
            <button class='btn-secondary' onclick='loadCustom("roar")'>ü¶Å Roar Zone TV</button>
            <button class='btn-secondary' onclick='loadCustom("crown")'>üëë Crown TV</button>
            <button class='btn-secondary' onclick='loadCustom("bangla")'>üáßüá© Bangla</button>
            <div id='playlist_history' style="text-align:left; margin-top:20px; font-size:12px;"></div>
        </div>
    </div>

    <div id='player-container'>
        <video autoplay id='player' playsinline></video>
    </div>

    <button class="pip-btn" id="pip_btn" onclick="togglePiP()">üì∫</button>

    <div class='overlay-panel' id='category-nav'>
        <div class='nav-header'>üìÅ CATEGORIES</div>
        <div class='list-container' id='category_list'></div>
        <div style='padding:15px;'><button id='logout-btn' onclick='logout()' style="width:100%; padding:10px; background:#ff4d4d; border:none; border-radius:8px; color:#fff; cursor:pointer;" tabindex="0">üö™ Change Playlist</button></div>
    </div>

    <div class='overlay-panel' id='channel-nav'>
        <div class='search-box'>
            <input type="text" id="channel_search" placeholder="Search channel..." onkeyup="filterChannels()" tabindex="0">
        </div>
        <div class='list-container' id='channel_list'></div>
    </div>

    <script>
    let allChannels = [], hls, dash, hideTimeout;
    let lastChannelFocus = null, lastCategoryFocus = null;
    let touchStartX = 0, touchEndX = 0;

    function loadCustom(type) {
        showLoader(true);
        let url = "";
        if(type === "roar") url = "https://raw.githubusercontent.com/omnixmain/OMNIX-PLAYLIST-ZONE/refs/heads/main/playlist/RoarZoneTv.m3u";
        if(type === "crown") url = "https://raw.githubusercontent.com/abusaeeidx/IPTV-Scraper-Zilla/refs/heads/main/BD.m3u";
        if(type === "bangla") url = "https://raw.githubusercontent.com/cctvccplc/Tv-Test/refs/heads/main/BD26.m3u8";
        fetchAndProcess(url, false);
    }

    async function loadFromLink(shouldSave = true) {
        const url = document.getElementById('pl_url').value.trim();
        if(!url) return;
        fetchAndProcess(url, shouldSave);
    }

    async function fetchAndProcess(url, shouldSave) {
        try {
            const res = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(url));
            const data = await res.text();
            processData(data);
            showLoader(false);
        } catch(e) { showLoader(false); alert("Connection Error!"); }
    }

    // Swipe Navigation
    document.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, false);
    document.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        const swipeDistance = touchEndX - touchStartX;
        if (swipeDistance > 100) {
            if (!document.getElementById("category-nav").classList.contains("show") && !document.getElementById("channel-nav").classList.contains("show")) showChannels(true);
            else if (document.getElementById("channel-nav").classList.contains("show")) showCategories(true);
        } else if (swipeDistance < -100) {
            if (document.getElementById("category-nav").classList.contains("show")) showChannels(true);
            else if (document.getElementById("channel-nav").classList.contains("show")) hideMenus();
        }
    }, false);

    function processData(data) {
        parseM3U(data);
        document.getElementById('boot_loader').style.display = 'none';
        document.getElementById('pip_btn').style.display = 'block';
        renderChannels(allChannels);
        if(allChannels.length > 0) playChannel(allChannels[0].url, null, true);
    }

    function parseM3U(data) {
        allChannels = []; const groups = new Set();
        let lines = data.split("\n");
        for (let i = 0; i < lines.length; i++) {
            if (lines[i].startsWith("#EXTINF")) {
                let info = {
                    name: lines[i].split(",").pop().trim(),
                    logo: lines[i].match(/tvg-logo="([^"]+)"/)?.[1] || "https://cdn-icons-png.flaticon.com/512/716/716429.png",
                    group: lines[i].match(/group-title="([^"]+)"/)?.[1] || "General"
                };
                groups.add(info.group);
                for (let j = i + 1; j < lines.length; j++) {
                    if (lines[j].trim().startsWith("http")) { info.url = lines[j].trim(); allChannels.push(info); i = j; break; }
                }
            }
        }
        const cb = document.getElementById("category_list");
        cb.innerHTML = `<div class="item cat-item" tabindex="0" onclick="renderChannels(allChannels, this)">üè† All Channels</div>`;
        Array.from(groups).sort().forEach(g => {
            cb.innerHTML += `<div class="item cat-item" tabindex="0" onclick="filterByCategory('${g}', this)">üìÅ ${g}</div>`;
        });
    }

    function renderChannels(list, el = null) {
        if(el) lastCategoryFocus = el;
        const cl = document.getElementById("channel_list");
        cl.innerHTML = list.map(ch => `
            <div class="item ch-item" tabindex="0" onclick='playChannel("${ch.url}", this)'>
                <img src="${ch.logo}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/716/716429.png'">
                <span>${ch.name}</span>
            </div>`).join('');
        showChannels(false);
    }

    function filterByCategory(g, el) {
        lastCategoryFocus = el;
        const filtered = allChannels.filter(c => c.group === g);
        renderChannels(filtered);
    }

    function filterChannels() {
        const query = document.getElementById("channel_search").value.toLowerCase();
        const filtered = allChannels.filter(ch => ch.name.toLowerCase().includes(query));
        const cl = document.getElementById("channel_list");
        cl.innerHTML = filtered.map(ch => `
            <div class="item ch-item" tabindex="0" onclick='playChannel("${ch.url}", this)'>
                <img src="${ch.logo}">
                <span>${ch.name}</span>
            </div>`).join('');
    }

    function playChannel(url, el, isAuto = false) {
        if(el) lastChannelFocus = el;
        showLoader(true);
        const video = document.getElementById("player");
        if(hls) hls.destroy(); if(dash) dash.reset();
        if(url.includes(".m3u8")) {
            if(Hls.isSupported()) { hls = new Hls(); hls.loadSource(url); hls.attachMedia(video); hls.on(Hls.Events.MANIFEST_PARSED,()=>video.play()); }
            else { video.src = url; video.play(); }
        } else if(url.includes(".mpd")) { dash = dashjs.MediaPlayer().create(); dash.initialize(video, url, true); }
        else { video.src = url; video.play(); }
        video.onplaying = () => showLoader(false);
        if(!isAuto) hideMenus();
    }

    // Fixed Keyboard Navigation
    window.addEventListener("keydown", (e) => {
        const catNav = document.getElementById("category-nav");
        const chNav = document.getElementById("channel-nav");
        const isCatShow = catNav.classList.contains("show");
        const isChShow = chNav.classList.contains("show");
        
        if(!isCatShow && !isChShow && ["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) { showChannels(true); return; }
        
        const active = document.activeElement;

        if (e.key === "ArrowDown") {
            e.preventDefault();
            if (active.nextElementSibling) {
                active.nextElementSibling.focus();
                active.nextElementSibling.scrollIntoView({ block: "nearest" });
            } else if (isCatShow && active.classList.contains('cat-item')) {
                document.getElementById("logout-btn").focus();
            }
        } 
        else if (e.key === "ArrowUp") {
            e.preventDefault();
            if (active.id === "logout-btn") {
                const lastCat = document.getElementById("category_list").lastElementChild;
                if(lastCat) lastCat.focus();
            } else if (active.previousElementSibling) {
                active.previousElementSibling.focus();
                active.previousElementSibling.scrollIntoView({ block: "nearest" });
            }
        }
        else if (e.key === "ArrowLeft") { e.preventDefault(); isChShow ? showCategories(true) : hideMenus(); }
        else if (e.key === "ArrowRight" && isCatShow) { e.preventDefault(); showChannels(true); }
        else if (e.key === "Enter") { e.preventDefault(); active.click(); }
        else if (e.key === "Escape") { e.preventDefault(); hideMenus(); }
        resetTimer();
    });

    function showChannels(restore = true) {
        hideMenus(); 
        const nav = document.getElementById("channel-nav");
        nav.classList.add("show");
        setTimeout(() => {
            let target = (restore && lastChannelFocus) ? lastChannelFocus : document.querySelector(".ch-item");
            if(!target) target = document.getElementById("channel_search");
            if(target) target.focus();
        }, 200);
    }

    function showCategories(restore = true) {
        hideMenus(); 
        const nav = document.getElementById("category-nav");
        nav.classList.add("show");
        setTimeout(() => {
            let target = (restore && lastCategoryFocus) ? lastCategoryFocus : document.querySelector(".cat-item");
            if(target) target.focus();
        }, 200);
    }

    function togglePiP() {
        const video = document.getElementById('player');
        if (document.pictureInPictureElement) document.exitPictureInPicture();
        else video.requestPictureInPicture();
    }

    function showLoader(show) { document.getElementById('loader').style.display = show ? 'block' : 'none'; }
    function hideMenus() { document.querySelectorAll(".overlay-panel").forEach(p => p.classList.remove("show")); }
    function resetTimer() { clearTimeout(hideTimeout); hideTimeout = setTimeout(hideMenus, 5000); }
    
    function logout() { 
        const video = document.getElementById("player");
        video.pause(); video.src = "";
        if(hls) hls.destroy(); if(dash) dash.reset();
        document.getElementById("boot_loader").style.display = "flex"; 
        document.getElementById('pip_btn').style.display = 'none';
        hideMenus(); 
    }

    function handleGlobalClick(e) { 
        if(!e.target.closest('.overlay-panel') && !e.target.closest('.setup-box')) {
            if(!document.querySelector(".overlay-panel.show")) showChannels(true);
        }
    }
    </script>
</body>
</html>
