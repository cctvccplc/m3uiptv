<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html b:css='false' b:defaultmessages='false' b:layoutsVersion='3' b:responsive='true' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b' xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>
<head>
    <meta charset='utf-8'/>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' name='viewport'/>
    <title>IPTV PRO - Multi Playlist</title>
    
    <script src='https://cdn.jsdelivr.net/npm/hls.js@latest'/>
    <script src='https://cdn.jsdelivr.net/npm/dashjs@latest/dist/dash.all.min.js'/>

    <b:skin><![CDATA[
    :root { --panel-bg: rgba(12, 12, 12, 0.98); --accent: #3b82f6; --glass: rgba(255, 255, 255, 0.08); --bg: #0a0a0a; }
    body, html { margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; touch-action: pan-y; }
    
    .setup-screen { position: fixed; inset: 0; z-index: 999; background: #000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .setup-box { background: #111; padding: 35px; border-radius: 25px; border: 1px solid #333; width: 100%; max-width: 420px; text-align: center; }
    .setup-box h2 { margin-bottom: 20px; color: var(--accent); }
    .setup-input { width: 100%; padding: 14px; background: #1a1a1a; border: 1px solid #444; color: #fff; border-radius: 12px; outline: none; box-sizing: border-box; margin-bottom: 15px;}
    .file-label { display: block; padding: 12px; background: var(--glass); border: 1px dashed #555; border-radius: 12px; cursor: pointer; margin-bottom: 15px; font-size: 14px; }
    #m3u_file { display: none; }
    .btn-primary { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
    .btn-secondary { width: 100%; padding: 12px; background: #222; color: #fff; border: 1px solid #444; border-radius: 12px; cursor: pointer; font-weight: bold; margin-bottom: 10px; outline: none;}
    .btn-secondary:focus { border-color: var(--accent); background: #2a2a2a; }

    .saved-container { text-align: left; border-top: 1px solid #333; padding-top: 20px; max-height: 180px; overflow-y: auto; }
    .saved-item { background: #1a1a1a; padding: 12px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid transparent; outline:none;}
    .saved-item:focus { border-color: var(--accent); background: rgba(59, 130, 246, 0.2); }

    #player-container { position: fixed; inset: 0; z-index: 1; background: #000; }
    video { width: 100%; height: 100%; object-fit: contain; }

    .overlay-panel { position: fixed; top: 0; bottom: 0; z-index: 100; background: var(--panel-bg); width: 280px; transform: translateX(-100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-right: 1px solid #333; backdrop-filter: blur(20px); }
    .overlay-panel.show { transform: translateX(0); }
    .nav-header { padding: 20px; font-weight: bold; border-bottom: 1px solid #333; color: var(--accent); }
    .list-container { height: calc(100% - 150px); overflow-y: auto; padding: 15px; }
    .item { padding: 12px; margin-bottom: 8px; border-radius: 10px; display: flex; align-items: center; cursor: pointer; background: var(--glass); outline: none; border: 2px solid transparent; }
    .item:focus { border-color: var(--accent); background: rgba(59, 130, 246, 0.2); }
    .item img { width: 35px; height: 35px; margin-right: 12px; border-radius: 5px; }
    
    #logout-btn { width: 100%; padding: 12px; background: #ff4d4d; border: none; border-radius: 8px; color: #fff; font-weight: bold; cursor: pointer; outline: none; border: 2px solid transparent;}
    #logout-btn:focus { border-color: #fff; background: #cc0000; }

    #blogger-section { display: none !important; }
    ]]></b:skin>
</head>
<body onclick='handleGlobalClick(event)'>

    <div id='blogger-section'><b:section id='main-section' maxwidgets='1' showaddelement='yes'/></div>

    <div class='setup-screen' id='boot_loader'>
        <div class='setup-box'>
            <h2>IPTV Manager</h2>
            <input class='setup-input' id='pl_url' placeholder='Paste M3U Link here...' type='text'/>
            <label class='file-label' for='m3u_file' id='file_status'>ğŸ“ Click to Upload M3U File</label>
            <input accept='.m3u,.m3u8' id='m3u_file' onchange='handleFileUpload(event)' type='file'/>
            <button class='btn-primary' onclick='loadFromLink(true)'>Load Playlist</button>
            <button class='btn-secondary' onclick='loadCustom("roar")'>ğŸ¦ Roar Zone TV</button>
            <button class='btn-secondary' onclick='loadCustom("crown")'>ğŸ‘‘ Crown TV</button>
            <button class='btn-secondary' onclick='loadCustom("bangla")'>ğŸ‡§ğŸ‡© Bangla</button>
            <div class='saved-container' id='playlist_history'/>
        </div>
    </div>

    <div id='player-container'><video autoplay='true' id='player' playsinline='true'/></div>

    <div class='overlay-panel' id='category-nav'>
        <div class='nav-header'>ğŸ“ CATEGORIES</div>
        <div class='list-container' id='category_list'/>
        <div style='padding:15px;'><button id='logout-btn' onclick='logout()' tabindex='0'>ğŸšª Change Playlist</button></div>
    </div>

    <div class='overlay-panel' id='channel-nav'>
        <div class='nav-header'>ğŸ“º CHANNELS <button onclick='showCategories(true)' style='float:right; background:#333; color:#fff; border:none; padding:4px 8px; border-radius:5px; font-size:10px;'>BACK</button></div>
        <div class='list-container' id='channel_list'/>
    </div>

    <script type='text/javascript'>
    //<![CDATA[
    let allChannels = [], hls, dash, hideTimeout;
    let lastChannelFocus = null, lastCategoryFocus = null;
    let touchStartX = 0, touchEndX = 0;
    const historyKey = "iptv_v110_stable";

    window.onload = renderHistory;

    function loadCustom(type) {
        let url = "";
        if(type === "roar") url = "https://raw.githubusercontent.com/omnixmain/OMNIX-PLAYLIST-ZONE/refs/heads/main/playlist/RoarZoneTv.m3u";
        if(type === "crown") url = "https://raw.githubusercontent.com/abusaeeidx/IPTV-Scraper-Zilla/refs/heads/main/BD.m3u";
        if(type === "bangla") url = "https://raw.githubusercontent.com/cctvccplc/Tv-Test/refs/heads/main/BD26.m3u8";
        
        document.getElementById('pl_url').value = ""; 
        fetchAndProcess(url, false);
    }

    document.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, false);
    document.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }, false);

    function handleSwipe() {
        const swipeDistance = touchEndX - touchStartX;
        const threshold = 100;
        const isCatShow = document.getElementById("category-nav").classList.contains("show");
        const isChShow = document.getElementById("channel-nav").classList.contains("show");

        if (swipeDistance > threshold) {
            if (!isCatShow && !isChShow) showChannels(true);
            else if (isChShow) showCategories(true);
        } else if (swipeDistance < -threshold) {
            if (isCatShow) showChannels(true);
            else if (isChShow) hideMenus();
        }
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
            document.getElementById('file_status').innerText = "âœ… " + file.name;
            const reader = new FileReader();
            reader.onload = (e) => { processData(e.target.result); savePlaylist(file.name, e.target.result, true); };
            reader.readAsText(file);
        }
    }

    async function loadFromLink(shouldSave = true) {
        const url = document.getElementById('pl_url').value.trim();
        if(!url) return;
        fetchAndProcess(url, shouldSave);
    }

    async function fetchAndProcess(url, shouldSave) {
        try {
            const res = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(url));
            const data = await res.text();
            processData(data); 
            if(shouldSave) savePlaylist(url, url, false);
            document.getElementById('pl_url').value = "";
        } catch(e) { alert("Link Error!"); }
    }

    function savePlaylist(name, data, isFile) {
        let list = JSON.parse(localStorage.getItem(historyKey) || "[]");
        list = list.filter(item => item.name !== name);
        list.unshift({ name, data, isFile });
        localStorage.setItem(historyKey, JSON.stringify(list.slice(0, 10)));
        renderHistory();
    }

    function renderHistory() {
        const list = JSON.parse(localStorage.getItem(historyKey) || "[]");
        const container = document.getElementById('playlist_history');
        container.innerHTML = list.length ? "<p style='font-size:11px; color:#666; margin-bottom:10px;'>SAVED PLAYLISTS</p>" : "";
        list.forEach((item, index) => {
            container.innerHTML += `<div class="saved-item" tabindex="0" onclick="loadSaved(${index})"><span>${item.isFile ? 'ğŸ“„' : 'ğŸ”—'} ${item.name}</span><div class="del-btn" onclick="deleteHistory(${index})">Ã—</div></div>`;
        });
    }

    function loadSaved(index) {
        const list = JSON.parse(localStorage.getItem(historyKey) || "[]");
        const item = list[index];
        if(item.isFile) processData(item.data);
        else fetchAndProcess(item.data, false);
    }

    function deleteHistory(index) {
        let list = JSON.parse(localStorage.getItem(historyKey) || "[]");
        list.splice(index, 1); localStorage.setItem(historyKey, JSON.stringify(list)); renderHistory();
    }

    function processData(data) {
        parseM3U(data);
        document.getElementById('boot_loader').style.display = 'none';
        filterGroup('all', true);
        if(allChannels.length > 0) playChannel(allChannels[0].url, null, true);
        showChannels(false);
    }

    function parseM3U(data) {
        allChannels = []; const groups = new Set();
        let lines = data.split("\n");
        for (let i = 0; i < lines.length; i++) {
            if (lines[i].startsWith("#EXTINF")) {
                let info = {
                    name: lines[i].split(",").pop().trim(),
                    logo: lines[i].match(/tvg-logo="([^"]+)"/)?.[1] || "https://cdn-icons-png.flaticon.com/512/716/716429.png",
                    group: lines[i].match(/group-title="([^"]+)"/)?.[1] || "General"
                };
                groups.add(info.group);
                for (let j = i + 1; j < lines.length; j++) {
                    if (lines[j].trim().startsWith("http")) { info.url = lines[j].trim(); allChannels.push(info); i = j; break; }
                }
            }
        }
        const cb = document.getElementById("category_list");
        cb.innerHTML = `<div class="item cat-item" tabindex="0" onclick="filterGroup('all', false, this)">ğŸ  All Channels</div>`;
        Array.from(groups).sort().forEach(g => { cb.innerHTML += `<div class="item cat-item" tabindex="0" onclick="filterGroup('${g}', false, this)">ğŸ“ ${g}</div>`; });
    }

    function filterGroup(g, isFirst = false, el = null) {
        if(el) lastCategoryFocus = el;
        const filtered = (g === 'all') ? allChannels : allChannels.filter(c => c.group === g);
        document.getElementById("channel_list").innerHTML = filtered.map(ch => `
            <div class="item ch-item" tabindex="0" onclick='playChannel("${ch.url}", this)'>
                <img src="${ch.logo}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/716/716429.png'"/>
                <span>${ch.name}</span>
            </div>`).join('');
        if(!isFirst) showChannels(false);
    }

    function playChannel(url, el, isAuto = false) {
        if(el) lastChannelFocus = el;
        const video = document.getElementById("player");
        if(hls) hls.destroy(); if(dash) dash.reset();
        if(url.includes(".m3u8")) {
            if(Hls.isSupported()) { hls = new Hls(); hls.loadSource(url); hls.attachMedia(video); hls.on(Hls.Events.MANIFEST_PARSED,()=>video.play()); }
            else { video.src = url; video.play(); }
        } else if(url.includes(".mpd")) { dash = dashjs.MediaPlayer().create(); dash.initialize(video, url, true); }
        else { video.src = url; video.play(); }
        if(!isAuto) hideMenus();
    }

    window.addEventListener("keydown", (e) => {
        const isCatShow = document.getElementById("category-nav").classList.contains("show");
        const isChShow = document.getElementById("channel-nav").classList.contains("show");
        if(!isCatShow && !isChShow && ["ArrowUp", "ArrowDown", "Enter"].includes(e.key)) { showChannels(true); return; }
        const active = document.activeElement;
        if (e.key === "ArrowDown") {
            e.preventDefault();
            if (active.nextElementSibling) { active.nextElementSibling.focus(); active.nextElementSibling.scrollIntoView({ block: "nearest" }); }
            else if (isCatShow && active.classList.contains('cat-item')) { document.getElementById("logout-btn").focus(); }
        } 
        else if (e.key === "ArrowUp") {
            e.preventDefault();
            if (active.id === "logout-btn") {
                const lastCat = document.getElementById("category_list").lastElementChild;
                if(lastCat) { lastCat.focus(); lastCat.scrollIntoView({ block: "nearest" }); }
            } else if (active.previousElementSibling) { active.previousElementSibling.focus(); active.previousElementSibling.scrollIntoView({ block: "nearest" }); }
        }
        else if (e.key === "ArrowLeft") { e.preventDefault(); isChShow ? showCategories(true) : hideMenus(); }
        else if (e.key === "ArrowRight" && isCatShow) { e.preventDefault(); showChannels(true); }
        else if (e.key === "Enter") { e.preventDefault(); active.click(); }
        else if (e.key === "Escape") { e.preventDefault(); hideMenus(); }
        resetTimer();
    });

    function showChannels(restore = true) {
        hideMenus(); document.getElementById("channel-nav").classList.add("show");
        setTimeout(() => {
            let target = (restore && lastChannelFocus) ? lastChannelFocus : document.querySelector(".ch-item");
            if(target) { target.focus(); target.scrollIntoView({ block: "center" }); }
        }, 150);
    }

    function showCategories(restore = true) {
        hideMenus(); document.getElementById("category-nav").classList.add("show");
        setTimeout(() => {
            let target = (restore && lastCategoryFocus) ? lastCategoryFocus : document.querySelector(".cat-item");
            if(target) { target.focus(); target.scrollIntoView({ block: "center" }); }
        }, 150);
    }

    function hideMenus() { document.querySelectorAll(".overlay-panel").forEach(p => p.classList.remove("show")); }
    function resetTimer() { clearTimeout(hideTimeout); hideTimeout = setTimeout(hideMenus, 4000); }
    
    function logout() { 
        const video = document.getElementById("player");
        video.pause(); video.src = ""; video.load();
        if(hls) hls.destroy(); if(dash) dash.reset();
        document.getElementById("boot_loader").style.display = "flex"; 
        hideMenus(); 
    }
    
    function handleGlobalClick(e) { if(!e.target.closest('.overlay-panel') && !e.target.closest('.setup-box')) { if(!document.querySelector(".overlay-panel.show")) showChannels(true); } }
    //]]>
    </script>
</body>
</html>
